{% extends "base.html" %}

{% block title %}Pendaftaran Pengguna{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-5">
        <div class="card shadow p-4 mt-5">
            <h2 class="card-title text-center mb-4"><i class="fa-solid fa-user-plus"></i> Daftar Akun Baru</h2>
            <form id="registerForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Username (Coba: test)</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password (Coba: test)</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Daftar Sekarang</button>
            </form>
            <div id="message" class="mt-3 text-center"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const messageDiv = document.getElementById('message');
        
        messageDiv.innerHTML = '<div class="alert alert-info">Sedang mendaftar...</div>';

        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (data.success) {
                // AMBIL ID PENGGUNA YANG BARU DIBUAT DARI RESPON API
                const newUserId = data.user_id; 
                
                messageDiv.innerHTML = `<div class="alert alert-success">
                    ${data.message}<br>Anda akan diarahkan ke Mulai Lari (User ID: ${newUserId}).
                </div>`;
                
                // REDIRECT KE START RUN MENGGUNAKAN ID DINAMIS
                setTimeout(() => {
                    window.location.href = '/web/start_run/' + newUserId;
                }, 2000); 
            } else {
                messageDiv.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
            }
        } catch (error) {
            console.error('Error saat mendaftar:', error);
            messageDiv.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan jaringan atau server.</div>`;
        }
    });
</script>
{% endblock %}
